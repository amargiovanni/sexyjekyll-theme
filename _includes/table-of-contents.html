{% assign t = site.data.i18n[site.lang] %}
{% if site.table_of_contents.enabled != false and page.toc != false %}
<aside class="table-of-contents" id="toc-container" aria-label="{{ t.toc.label }}">
  <div class="toc-header">
    <h2 class="toc-title">{{ t.toc.title }}</h2>
    <button class="toc-toggle" id="toc-toggle" aria-expanded="true" aria-controls="toc-list" aria-label="{{ t.toc.toggle }}">
      <span class="toc-toggle-icon"></span>
    </button>
  </div>
  <nav id="toc-list" class="toc-list" role="navigation">
    <!-- TOC will be generated by JavaScript -->
  </nav>
</aside>
{% endif %}

<script>
document.addEventListener('DOMContentLoaded', function() {
  'use strict';

  const content = document.querySelector('.post-content');
  const tocList = document.getElementById('toc-list');
  const tocContainer = document.getElementById('toc-container');
  const tocToggle = document.getElementById('toc-toggle');

  if (!content || !tocList || !tocContainer) {
    console.log('TOC: Missing required elements');
    return;
  }

  // Find all headings in the content (h2, h3, h4)
  const headings = content.querySelectorAll('h2, h3, h4');

  console.log('TOC: Found', headings.length, 'headings');

  if (headings.length === 0) {
    // No headings found, hide TOC
    if (tocContainer) {
      tocContainer.style.display = 'none';
    }
    return;
  }

  // Generate IDs for headings if they don't have them
  headings.forEach((heading, index) => {
    if (!heading.id) {
      const text = heading.textContent.trim();
      const id = text
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '') || `heading-${index}`;
      heading.id = id;
    }
  });

  // Build TOC HTML
  let tocHTML = '<ul class="toc-items">';
  let currentLevel = 2;

  headings.forEach((heading) => {
    const level = parseInt(heading.tagName.substring(1));
    const title = heading.textContent.trim();
    const id = heading.id;

    if (level > currentLevel) {
      // Open nested list
      tocHTML += '<ul class="toc-items">';
    } else if (level < currentLevel) {
      // Close nested lists
      for (let i = currentLevel; i > level; i--) {
        tocHTML += '</ul></li>';
      }
    } else if (currentLevel === level && tocHTML !== '<ul class="toc-items">') {
      // Close previous item
      tocHTML += '</li>';
    }

    tocHTML += `<li class="toc-item toc-level-${level}">
      <a href="#${id}" class="toc-link">${title}</a>`;

    currentLevel = level;
  });

  // Close remaining lists
  for (let i = currentLevel; i >= 2; i--) {
    tocHTML += '</li>';
  }
  tocHTML += '</ul>';

  tocList.innerHTML = tocHTML;

  // Toggle TOC visibility
  if (tocToggle) {
    tocToggle.addEventListener('click', function() {
      const isExpanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', !isExpanded);
      tocList.classList.toggle('toc-collapsed');
    });
  }

  // Highlight active section on scroll
  function highlightActiveSection() {
    let currentActive = null;
    const scrollPos = window.scrollY + 100;

    headings.forEach((heading) => {
      const top = heading.offsetTop;
      if (scrollPos >= top) {
        currentActive = heading.id;
      }
    });

    document.querySelectorAll('.toc-link').forEach((link) => {
      link.classList.remove('active');
      if (currentActive && link.getAttribute('href') === `#${currentActive}`) {
        link.classList.add('active');
      }
    });
  }

  // Smooth scroll to section
  document.querySelectorAll('.toc-link').forEach((link) => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const targetId = this.getAttribute('href').substring(1);
      const target = document.getElementById(targetId);
      if (target) {
        const offset = 80; // Account for fixed header
        const targetPosition = target.offsetTop - offset;
        window.scrollTo({
          top: targetPosition,
          behavior: 'smooth'
        });
        // Update URL without jumping
        history.pushState(null, null, `#${targetId}`);
      }
    });
  });

  // Update active section on scroll (throttled)
  let ticking = false;
  window.addEventListener('scroll', function() {
    if (!ticking) {
      window.requestAnimationFrame(function() {
        highlightActiveSection();
        ticking = false;
      });
      ticking = true;
    }
  });

  // Initial highlight
  highlightActiveSection();
});
</script>
